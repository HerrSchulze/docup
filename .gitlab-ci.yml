# GitLab CI/CD Pipeline for DocUp Application
# Simplified and robust pipeline

stages:
  - build
  - test
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

cache:
  paths:
    - .m2/repository/
    - frontend/node_modules/

# Backend Build
build-backend:
  stage: build
  image: maven:3.9-openjdk-17
  script:
    - echo "ğŸ—ï¸ Building backend..."
    - cd backend
    - mvn clean compile
    - mvn package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar
    expire_in: 1 hour

# Frontend Build  
build-frontend:
  stage: build
  image: node:18-alpine
  script:
    - echo "ğŸ—ï¸ Building frontend..."
    - cd frontend
    - npm install --legacy-peer-deps
    - npm run build
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 1 hour
  cache:
    paths:
      - frontend/node_modules/

# Backend Tests
test-backend:
  stage: test
  image: maven:3.9-openjdk-17
  dependencies:
    - build-backend
  script:
    - echo "ğŸ§ª Testing backend..."
    - cd backend
    - mvn test
  artifacts:
    when: always
    reports:
      junit:
        - backend/target/surefire-reports/TEST-*.xml
    expire_in: 1 week
  allow_failure: true

# Frontend Tests
test-frontend:
  stage: test
  image: node:18-alpine
  dependencies:
    - build-frontend
  script:
    - echo "ğŸ§ª Testing frontend..."
    - cd frontend
    - npm install --legacy-peer-deps
    - npm run test -- --watch=false --browsers=ChromeHeadless || true
  allow_failure: true

# Security Scan (Optional)
security-backend:
  stage: test
  image: maven:3.9-openjdk-17
  dependencies:
    - build-backend
  script:
    - echo "ğŸ” Security scanning backend..."
    - cd backend
    - mvn org.owasp:dependency-check-maven:check || true
  artifacts:
    when: always
    paths:
      - backend/target/dependency-check-report.html
    expire_in: 1 week
  allow_failure: true

# Deploy to Staging
deploy-staging:
  stage: deploy
  script:
    - echo "ğŸš€ Deploying to staging..."
    - echo "Deployment would happen here"
  environment:
    name: staging
  only:
    - main
  when: manual
